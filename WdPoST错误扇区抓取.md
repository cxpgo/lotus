# **`WdPoST错误扇区抓取功能`**

## `目录`
- 开发功能的原因
- 需要解决的问题
- 已经实现的功能
- 目前获取的数据
- 依据数据的推论
- 实际操作中建议


### `开发功能的原因`
- 要实现修复错误扇区，必须找到全部错误的扇区
- 第一种方案：根据已知WdPoST错误扇区，找到对应的Woker机器；
然后把该Worker机器密封过的所有扇区，都定为疑似错误扇区。
- 根据上面方案,在获取扇区的过程中,发现以下问题  
    * 节点曾经出现过的错误扇区，没有准确数据来源
    * 很多节点t_sector_sealing_info表，会定期清理数据，无法获取可疑Worker曾经密封的扇区信息
    * 与节点已知出错扇区相关联Worker，曾经密封过的扇区数量过多 
        - f0410001 已知错误扇区`9`个,相关Worker`1`个,相关扇区`144`个
        - f0407733 已知错误扇区`6`个,相关Worker`1`个,相关扇区`366`个
        - f0133505 已知错误扇区`16`个,相关Worker`2`个,相关扇区`3156`个
        - f0133501 已知错误扇区`14`个,相关Worker`4`个,相关扇区`3656`个
        - f089200  &nbsp;已知错误扇区`25`个,相关Worker`23`个,相关扇区`31549`个
    * 疑似错误扇区过多，在实际修复过程，会导致时间长，成本高等问题
- `有没有更好的，更准确的方法，统计错误扇区？`
    - 在实践中发现，通过链上DeclareFaultsRecovered消息，可以更准确的统计节点中曾经出错过的扇区

### `需要解决的问题`
- DeclareFaultsRecovered消息中，有整个deadline错误，导致出现大量需要恢复的扇区
- 公司7月中旬至下旬，搬迁了大量机器，导致出现大量需要恢复的扇区
- DeclareFaultsRecovered消息时间跨度长（最早:2020-08-28）

### `已经实现的功能`
- 根据节点号，获取DeclareFaultsRecovered消息中，曾经出错过的所有扇区号
- 各节点出错扇区，统计数据维度：
    - 出错扇区总数（去重）
    - 总共出错次数 （个数*次数） 
    - 不同出错次数，所包含的扇区个数
    - 每个扇区曾经出错的次数
    - 所有曾经出错的扇区号

### `目前获取的数据`   
- `25`节点的`816`个扇区，共出现`1671`次错误
- 多个扇区重复出现错误 例:
    - f0407733  &nbsp;30680                       &nbsp;&nbsp;&nbsp;17次
    - f016398   &nbsp;&nbsp;&nbsp;&nbsp;429445    &nbsp;19次
    - f061959   &nbsp;&nbsp;&nbsp;&nbsp;69744     &nbsp;&nbsp;&nbsp;49次
- 只出现一次的扇区为`572`个,占总出错次数`34%`,占总出错个数`70%`

### `依据数据的推论`
- 曾经出错过的扇区(`816`),只占理论上可能出错的扇区(`38871`(4个节点数据)),很少的一部分
- 扇区出错具有随机性，同一个扇区可能会被多次检测到错误
- 同一个扇区的多次重复出错，占总出错次数较大的比例(`70%`)
- 扇区出错问题，时间跨度较长；大部分节点，都曾经出现过错误

### `实际操作中建议`
- f0407733节点，所有错误扇区经过重新密封证明全部出错，可以全部修复。
- 其它节点，可以优先修复高优先级错误扇区(曾经出错过的)
- 可以定时获取新出错扇区(例如：一周)，然后集中进行修复
- 该修复方案，性价比较高